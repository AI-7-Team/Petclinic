{% extends 'index.html' %}
{% block content %}

<meta charset="UTF-8">
<title>PetScan 분석 결과</title>

<div class="grid">

    <div class="row">
        <div class="col text-center">
            <p class="p-text">
                📍 PetScan의 AI 분석 결과입니다. 분석 결과는 참고용이며, 정확한 진단은 반드시 전문 수의사와 상담하세요.<br>
            </p>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6 result-col">
            <p class="result-left">분석 결과</p>

            {% if img_data %}
                <img class="result-img" src="data:image/jpeg;base64,{{ img_data }}" alt="업로드된 이미지">
            {% else %}
                <p>이미지를 표시할 수 없습니다.</p>
            {% endif %}

            {% if prediction %}
                <div class="prediction-box">
                    {# [수정됨] 진단명과 함께 정확도(confidence)를 표시합니다. #}
                    <p><strong>진단명:</strong> {{ description_data.title if description_data else prediction }}</p>
                </div>
            {% else %}
                <div class="prediction-box">
                    <p><strong>진단 결과가 없습니다.</strong></p>
                </div>
            {% endif %}
        </div>

        <div class="col-md-6 result-explanation">
            <p class="result-right">결과 설명</p>

            {% if description_data and description_data.title != '알 수 없는 증상' and prediction != 'A7' %}
                <p class="paragraph"><strong>💬 {{ description_data.title }}</strong></p>
                <p class="paragraph">{{ description_data.description }}</p>
            {% elif prediction == 'A7' %}
                 <p class="paragraph">
                    <strong>탐지된 이상 증상이 없습니다.</strong><br><br>
                    AI 분석 결과, 반려동물의 피부는 건강한 상태로 보입니다.<br>
                    결과는 참고용이므로, 평소와 다른 점이 느껴진다면 수의사와 상담하는 것을 권장합니다.
                </p>
            {% else %}
                <p class="paragraph">
                    <strong>탐지된 증상에 대한 설명이 없습니다.</strong><br><br>
                    AI가 업로드된 이미지를 분석했지만, 학습된 데이터 내에서 유의미한 결과를 찾지 못했습니다.<br>
                    사진의 초점이 맞지 않거나, 빛 반사가 심하거나, 증상이 명확하지 않은 경우일 수 있습니다.<br>
                    다른 각도에서 선명한 사진으로 다시 시도해 보세요.
                </p>
            {% endif %}

            {# [수정됨] GPT 응답을 동적으로 표시하기 위한 HTML 구조 #}
            <div class="gpt-response-box" id="gpt-response-container">
                <p class="paragraph">
                    <strong>💬 멍냥닥터 답변</strong><br><br>
                    <span id="gpt-response-text">멍냥닥터에게 물어보는 중입니다... 잠시만 기다려주세요.</span>
                </p>
            </div>
        </div>
    </div>
</div>

{# [추가됨] GPT 응답을 비동기적으로 불러오는 JavaScript #}
<script>
    // 페이지 로딩이 완료되면 스크립트를 실행합니다.
    document.addEventListener('DOMContentLoaded', function() {
        // Flask 템플릿에서 예측된 클래스 값을 가져옵니다.
        const predictedClass = "{{ prediction }}";
        const container = document.getElementById('gpt-response-container');
        const target = document.getElementById('gpt-response-text');

        // 예측된 클래스가 존재할 경우에만 GPT API에 요청을 보냅니다.
        if (predictedClass) {
            fetch('/gpt', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                // 예측된 클래스 값을 JSON 형태로 body에 담아 보냅니다.
                body: JSON.stringify({ predicted_class: predictedClass })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // 응답받은 메시지를 gpt-response-text 영역에 표시합니다.
                if (data.message) {
                    target.innerText = data.message;
                } else {
                    target.innerText = '멍냥닥터로부터 답변을 받는 데 실패했습니다.';
                }
            })
            .catch(error => {
                console.error('Error fetching GPT response:', error);
                target.innerText = '오류가 발생하여 멍냥닥터 답변을 불러올 수 없습니다.';
            });
        } else {
            // 예측된 클래스가 없는 경우 GPT 호출을 시도하지 않습니다.
             container.style.display = 'none';
        }
    });
</script>
{% endblock %}